<!DOCTYPE html>
<html>
	<head>
		<title>Lifetracker</title>
		<link rel="stylesheet" href="style/main.css" type="text/css">
		<link type="text/css" href="style/jquery-ui-1.8.18.custom.css" rel="stylesheet" />
		<script type="text/javascript" src="script/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="script/jquery-ui-1.8.18.custom.min.js"></script>
		<meta name="viewport" content="width=device-width"/>
	</head>
	<body>
		<div>
			Date <input id="when_date" type="date"/><br/>
			Time <select id="when_hour"></select>
			<select id="when_min"></select>
			<div>Food.where: <input id="food-where" type="text" size="10" value="Home"/>
			<div>Food.what: <ul id="food-what"></ul></div>
			<input id="new-food-what"/><br/>
			<button onclick="addFood();">+ food</button>
			<button onclick="saveEvent();">Save</button>
		</div>
		<div id="recent_events"></div>
	</body>
	<script src="/_utils/script/sha1.js"></script>
	<script src="/_utils/script/json2.js"></script>
	<script src="/_utils/script/jquery.couch.js"></script>
	<script src="vendor/couchapp/jquery.couchLogin.js"></script>
	<script src="vendor/couchapp/jquery.couchProfile.js"></script>
	<script src="vendor/couchapp/md5.js"></script>
	<script src="vendor/couchapp/jquery.mustache.js"></script>

	<!-- templates used by app.js -->
	<script id="recent-events" type="text/x-mustache" charset="utf-8">
		<h3>Recent Events</h3>
		<ul>{{#events}}
			<li><b>{{when}}</b>: Ate food from {{where}}:<ul>{{#what}}<li>{{.}}{{/what}}</ul></li>
		{{/events}}</ul>
	</script>
	<script type="text/javascript">
function addFood() {
	var id = "food-what-" + Math.floor(Math.random()*9999999);
	var foodField = $("#new-food-what");
	var food = foodField.val();
	foodField.val('');
	$("#food-what").append($('<li id="'+id+'"><span>'+food+'</span> <button onclick="deleteFood(\''+id+'\');">-</button>'));
}

function deleteFood(id) {
	$("#"+id).remove();
}

function saveEvent() {
	var event = {};
	var dateParts = $("#when_date").val().split("-");
	var hour = $('#when_hour').val();
	var min = $('#when_min').val();
	var date = new Date(dateParts[0], dateParts[1]-1, dateParts[2], hour, min, 0, 0);
	event.when = {};
	event.when.utc = Math.floor(date.getTime() / 1000);
	event.when.offset = date.getTimezoneOffset();
	event.when.local = [ date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes() ];
	event.food = {};
	event.food.where = $("#food-where").val();
	event.food.what = [];
	$('#food-what > li > span').each(function(key,node){
		var text = $(node).text();
		event.food.what.push(text);
	});
	db.saveDoc(event, {
		success: function() {
			drawEvents();
		},
		error: function(jqXHR, textStatus, errorThrown) {
			alert("Cannot save event: " + textStatus);
		}
	});
}

function drawEvents() {
	db.view(design + "/events", {
		descending : "true",
		limit : 5,
		update_seq : true,
		success : function(data) {
			var them = $.mustache($("#recent-events").html(), {
				events : data.rows.map(function(r) {
					var result = {};
					var when = r.value.when.local;
					result.when = when[1]+" "+when[2]+", "+when[0]+" @"+when[3]+":"+when[4];
					result.where = r.value.food.where;
					result.what = r.value.food.what;
					return result;
				})
			});
			$("#recent_events").html(them);
		}
	});
};

function populateAutoSuggest(field, key) {
	db.view(design + "/event_values", {
		group: true,
		startkey: [key],
		endkey: [key,{}],
		success: function(data) {
			var results = data.rows.map(function(r){
				return r.key[1];
			});
			field.autocomplete({"source":results});
		}
	});
}

var design, db;
$(function() {
	var path = unescape(document.location.pathname).split('/');
	design = path[3];
	db = $.couch.db(path[1]);
	{
		var now = new Date();
		var month = now.getMonth() + 1;
		if (month < 10) { month = '0' + month; }
		var day = now.getDate();
		if (day < 10) { day = '0' + day; }
		$('#when_date').val(now.getFullYear()+"-"+month+ "-"+day);
		
		var fillSelect = function(element, max, current) {
			for (var i = 0; i < max; i++) {
				var temp = ''+i;
				if (i < 10) { temp = '0'+i; }
				if (i == current) {
					temp = '<option selected>'+temp+'</option>';
				} else {
					temp = '<option>'+temp+'</option>';
				}
				element.append(temp);
			}
		}
		fillSelect($('#when_hour'), 24, now.getHours());
		fillSelect($('#when_min'), 60, now.getMinutes());
		
		populateAutoSuggest($("#food-where"), "food.where");
		populateAutoSuggest($("#new-food-what"), "food.what");
	}
	drawEvents();
});
	</script>
</html>
