<!DOCTYPE html>
<html>
	<head>
		<title>Lifetracker</title>
		<link rel="stylesheet" href="style/main.css" type="text/css">
		<link type="text/css" href="style/jquery-ui-1.8.18.custom.css" rel="stylesheet" />
		<script type="text/javascript" src="script/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="script/jquery-ui-1.8.18.custom.min.js"></script>
		<meta name="viewport" content="width=device-width"/>
	</head>
	<body>
		<div id="menu">
			<span class="menu-item">[ <a href="index.html">Show events</a> ]</span>
		</div>
		<div>
			Date <input id="when-date" type="date"/><br/>
			Time <select id="when-hour"></select>
			<select id="when-min"></select>
			<ul id="properties"></ul>
			Key <input id="new-key" type="text"/><br/>
			Value <input id="new-value" type="text"/><br/>
			<button onclick="addProperty();">+</button><br/>
			<button onclick="saveEvent();">Save</button>
			<button onclick="deleteEvent();">Delete</button>
		</div>
	</body>
	<script src="/_utils/script/sha1.js"></script>
	<script src="/_utils/script/json2.js"></script>
	<script src="/_utils/script/jquery.couch.js"></script>
	<script src="vendor/couchapp/md5.js"></script>
	<script src="vendor/couchapp/jquery.mustache.js"></script>
	
	<script id="property-key-template" type="text/x-mustache" charset="utf-8">
		<li class="event-node-value" id="{{id}}" type="{{type}}">
			<span class="key">{{key}}</span> =
		</li>
	</script>
	<script id="property-value-template" type="text/x-mustache" charset="utf-8">
		<button onclick="removeProperty(this);">{{value}}</button>
	</script>
	<script src="script/helpers/walkNodes.js"></script>
	<script type="text/javascript">
var myevent = {};
var types = {};

var design;
var db;
$(function() {
	db = $.couch.db(unescape(document.location.pathname).split('/')[1]);
	design = unescape(document.location.pathname).split('/')[3];
	initDate();
	$("#new-key").blur(populateValueAutoSuggest);
	
	populateKeyAutoSuggest(function() {
		var hash = document.location.hash.substring(1);
		if (hash.length == 0) {
			addKeyValue("type","event");
		} else {
			var parts = hash.split("=");
			if (parts[0] == "id") {
				db.openDoc(parts[1], {
					success: function(data) {
						console.log("Loaded", data);
						myevent._id = data._id;
						myevent._rev = data._rev;
						initDate(new Date(data.when.utc * 1000));
						processNode(null, data, {
							"array" : function(prefix, node) {
								for (var i = 0; i < node.length; i++) {
									addKeyValue(prefix, node[i]);
								}
							},
							"value" : function(prefix, node) { addKeyValue(prefix, node); }
						});
					},
					error: function(jqXHR, textStatus, errorThrown) {
						if (jqXHR == 404) {
							alert("Event does not exist");
						} else {
							alert("Some other error: " + textStatus);
						}
					}
				});
			}
		}
	});
});

function populateKeyAutoSuggest(after) {
	db.view(design + "/types", {
		group: true,
		success: function(data) {
			var results = data.rows.map(function(r){
				types[r.key] = r.value;
				return r.key;
			});
			$("#new-key").autocomplete({"source":results});
			after();
		}
	});
}

function populateValueAutoSuggest() {
	var key = $("#new-key").val();
	db.view(design + "/values", {
		group: true,
		startkey: [key],
		endkey: [key,{}],
		success: function(data) {
			var results = data.rows.map(function(r){
				return r.key[1];
			});
			$("#new-value").autocomplete({"source":results});
		}
	});
}

function buildObject(event, keyParts, value) {
	if (keyParts.length == 1) {
		event[keyParts[0]] = value;
	} else {
		var node = event[keyParts[0]];
		if (node == null) {
			node = {};
			event[keyParts[0]] = node;
		}
		buildObject(node,  keyParts.slice(1,keyParts.length), value);
	}
}

function saveEvent() {
	myevent.when = getWhen();
	try {
		$('#properties').children().each(function(key,node){
			var node = $(node);
			var key = node.children(".key").text();
			var values = [];
			node.children("button").each(function(key, node){
				values.push($(node).text());
			});
			if (values.length == 1) { values = values[0]; }
			
			var forceNoArray = function(values, key, type) {
				if (Array.isArray(values)) { throw(key + " should be a " + type + " not an array"); }
			};
			
			switch (node.attr("type")) {
				case "array":
					if (!Array.isArray(values)) {
						values = [ values ];
					}
					break;
				case "number":
					forceNoArray(values, key, "number");
					values = parseFloat(values);
					break;
				case "boolean":
					forceNoArray(values, key, "boolean");
					values = (values.toLowerCase() === "true");
					break;
				case "string":
					forceNoArray(values, key, "string");
			}
			buildObject(myevent, key.split("."), values);
		});
	} catch (e) {
		alert(e);
		return;
	}
	db.saveDoc(myevent, {
		success: function() {
			window.location.href = "./index.html";
		},
		error: function(jqXHR, textStatus, errorThrown) {
			alert("Cannot save event: " + textStatus);
		}
	});
}

function deleteEvent() {
	if (!myevent._id) {
		window.location.href = "./index.html";
	}
	
	db.removeDoc(myevent, {
		success: function() {
			window.location.href = "./index.html";
		},
		error: function(jqXHR, textStatus, errorThrown) {
			alert("Cannot delete event: " + textStatus);
		}
	});
}

function getWhen() {
	var dateParts = $("#when-date").val().split("-");
	var hour = $('#when-hour').val();
	var min = $('#when-min').val();
	var date = new Date(dateParts[0], dateParts[1]-1, dateParts[2], hour, min, 0, 0);
	return {
		utc : Math.floor(date.getTime() / 1000),
		offset : date.getTimezoneOffset(),
		local : [ date.getFullYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes() ]
	};
}

function removeProperty(node) {
	var valueNode = $(node);
	var parent = valueNode.parent();
	valueNode.remove();
	if (parent.children("button").length == 0) {
		parent.remove();
	}
}

function addProperty() {
	var valueElement = $("#new-value");
	addKeyValue($("#new-key").val(), valueElement.val());
	valueElement.val('');
	valueElement.focus();
}

function addKeyValue(key, value) {
	var id = "property_"+key.replace(/\./g, '_');
	var node = $("#"+id);
	if (node.length == 0) {
		var info = {
			key : key,
			id : "property_"+key.replace(/\./g, '_'),
			type: "new"
		};
		if (types[key]) {
			info.type = types[key];
		}
		$("#properties").append($.mustache($("#property-key-template").html(), info));
		node = $("#"+id);
	}
	node.append($.mustache($("#property-value-template").html(), {
		value : value
	}));
}

function fill(number) {
	if (number <= 9) { return "0"+number; }
	return ""+number;
}

function initDate(now) {
	if (!now) { now = new Date(); }
	$("#when-date").val(now.getFullYear()+"-"+fill(now.getMonth() + 1)+ "-"+fill(now.getDate()));
	var fillSelect = function(element, max, current) {
		for (var i = 0; i < max; i++) {
			var temp = fill(i);
			if (i == current) {
				temp = '<option selected>'+temp+'</option>';
			} else {
				temp = '<option>'+temp+'</option>';
			}
			element.append(temp);
		}
	}
	fillSelect($("#when-hour"), 24, now.getHours());
	fillSelect($("#when-min"), 60, now.getMinutes());
}
	</script>
</html>
