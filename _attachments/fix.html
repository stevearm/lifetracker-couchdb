<!DOCTYPE html>
<html>
	<head>
		<title>Lifetracker</title>
		<link rel="stylesheet" href="style/main.css" type="text/css">
	</head>
	<body>
		<div>
			Select function<br/>
			<textarea id="select" rows="10" cols="100">function(doc) {
  // Return true if you need to fix this document
  if (!("type" in doc)) { return true; }
  return false;
}</textarea>
		</div>
		<button onclick="tryScanFunc();">Scan</button>
		<div>
			Fix function<br/>
			<textarea id="fix" rows="10" cols="100">function(doc) {
  // Fix the doc's properties
  doc.type="event";
}</textarea>
		</div>
		<button onclick="tryFixFunc();">Process</button>
		<button onclick="saveCurrent();">Save current</button>
		<button onclick="skipCurrent();">Skip current</button>
		<div id="count">
			Number of events: <span class="value"/>
		</div>
		<div id="from">
			From: <span class="value"/>
		</div>
		<div id="to">
			To: <span class="value"/>
		</div>
	</body>
	<script src="/_utils/script/sha1.js"></script>
	<script src="/_utils/script/json2.js"></script>
	<script src="/_utils/script/jquery.js"></script>
	<script src="/_utils/script/jquery.couch.js"></script>
	<script src="vendor/couchapp/md5.js"></script>
	<script type="text/javascript">
var sourceEvents = [];
var countSpan;
var fromSpan;
var toSpan;
var db;
$(function() {
	db = $.couch.db(unescape(document.location.pathname).split('/')[1]);
	countSpan = $("#count > .value");
	fromSpan = $("#from > .value");
	toSpan = $("#to > .value");
});

var fixFail = function(error) {
	return function(doc) {
		throw(error);
	};
};
var fixFunction = fixFail("Not parsed yet");

var showCurrentFrom = function() {
	countSpan.text(sourceEvents.length);
	if (sourceEvents.length == 0) {
		fromSpan.text("No events");
	} else {
		var event = sourceEvents[0];
		fromSpan.text(JSON.stringify(event));
		showCurrentTo();
	}
};

var showCurrentTo = function() {
	var sourceText = fromSpan.text();
	if (sourceText == "No events") {
		toSpan.text("No events");
	} else {
		try {
			var event = JSON.parse(sourceText);
			fixFunction(event);
			toSpan.text(JSON.stringify(event));
		} catch (e) {
			toSpan.text("Error running fix function: " + e.toString());
		}
	}
};

var saveCurrent = function() {
	var event = JSON.parse(toSpan.text());
	db.saveDoc(event, {
		success: function() {
			skipCurrent();
		},
		error: function(jqXHR, textStatus, errorThrown) {
			toSpan.text("Cannot save event: " + errorThrown);
		}
	});
}

var skipCurrent = function() {
	sourceEvents.splice(0,1);
	showCurrentFrom();
}

var tryFixFunc = function() {
	var userFunc = $("#fix").val();
	var fix;
	try {
		eval("fix="+userFunc);
		fixFunction = fix;
	} catch (e) {
		fixFunction = fixFail(e.toString());
	}
	showCurrentTo();
};

var tryScanFunc = function() {
	var userFunc = $("#select").val();
	var selectText = "function(doc){var test="+userFunc+";if(test(doc)){emit(null,doc);}}";
	var select;
	try {
		eval("select="+selectText);
	} catch (e) {
		fromSpan.text("Failed parsing select function: " + e.toString());
		return;
	}
	db.query(select, null, "javascript", {
		success: function(data){
			sourceEvents = data.rows.map(function(obj){
				return obj.value;
			});
			showCurrentFrom();
		},
		error: function(data){
			fromSpan.text("Failed loading: " + JSON.stringify(data));
		}
	});
};
	</script>
</html>
